# Ignis Infrastructure

Scripts and configuration for deploying Ignis to production.

## Quick Start

```bash
# 1. Copy and configure environment
cp .env.example .env
# Edit .env with your API keys (at minimum: AIDBOX_LICENSE_KEY)

# 2. Run setup (auto-generates JWT_SECRET if not set)
./infra/setup-services.sh

# 3. Optional: Enable SSL
./infra/setup-ssl.sh
```

## Environment Variables

### Required

| Variable | Description | How to Get |
|----------|-------------|------------|
| `AIDBOX_LICENSE_KEY` | Aidbox FHIR server license | [aidbox.app](https://aidbox.app) → Assets → New Aidbox |

### Auto-Generated

| Variable | Description | Notes |
|----------|-------------|-------|
| `JWT_SECRET` | Secret for signing auth tokens | Auto-generated by `setup-services.sh` if not set. Generate manually: `openssl rand -base64 32` |

### Optional - Voice & Telephony

| Variable | Description | How to Get |
|----------|-------------|------------|
| `ELEVENLABS_API_KEY` | ElevenLabs voice synthesis API | [elevenlabs.io](https://elevenlabs.io) |
| `ELEVENLABS_AGENT_ID` | ElevenLabs Conversational AI agent | ElevenLabs dashboard → Conversational AI |
| `TWILIO_ACCOUNT_SID` | Twilio account identifier | [console.twilio.com](https://console.twilio.com) |
| `TWILIO_AUTH_TOKEN` | Twilio authentication token | Twilio console |
| `TWILIO_PHONE_NUMBER` | Twilio phone number (E.164 format) | Twilio console → Phone Numbers |

### Optional - SSL & Domain

| Variable | Description |
|----------|-------------|
| `DOMAIN` | Domain for SSL/HTTPS (e.g., `ignis.cognovis.de`) |
| `SSL_EMAIL` | Email for Let's Encrypt certificate |

### Optional - LLM APIs

| Variable | Description |
|----------|-------------|
| `OPENAI_API_KEY` | OpenAI API for LLM features |
| `GOOGLE_AI_API_KEY` | Google AI API |

## Scripts

| Script | Description |
|--------|-------------|
| `setup-services.sh` | Main setup script - starts all Docker services |
| `setup-ssl.sh` | Configure SSL/HTTPS with Let's Encrypt |
| `setup-remote.sh` | Configure a fresh server after provisioning |
| `load-synthea-data.sh` | Load synthetic patient data |
| `generate-appointments.sh` | Generate sample appointments |
| `deploy-twilio.sh` | Configure Twilio webhooks |
| `update-server.sh` | Pull latest code and rebuild |
| `teardown.sh` | Stop and remove all services |

## Docker Services

| Service | Port | Description |
|---------|------|-------------|
| `nginx` | 80, 443 | Reverse proxy |
| `app` | 3000 (internal) | Bun backend + React frontend |
| `app2` | 3001 (internal) | Next.js design system |
| `aidbox` | 8080 (internal) | FHIR R4 server |
| `aidbox-db` | 5432 (internal) | PostgreSQL for Aidbox |

## Troubleshooting

### App container restart loop

Check logs:
```bash
docker logs ignis-app-1 --tail=50
```

Common issues:
- **"JWT_SECRET must be set in production"**: Add `JWT_SECRET` to `.env` or regenerate:
  ```bash
  echo "JWT_SECRET=$(openssl rand -base64 32)" >> .env
  docker compose up -d app
  ```

### Aidbox not starting

1. Check license key is set in `.env`
2. Check PostgreSQL is healthy: `docker compose logs aidbox-db`
3. Check Aidbox logs: `docker compose logs aidbox`

### SSL issues

1. Ensure `DOMAIN` is set and DNS points to server
2. Run `./infra/setup-ssl.sh`
3. Check nginx config: `docker compose exec nginx nginx -t`
